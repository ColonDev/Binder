<th:block xmlns:th="http://www.thymeleaf.org">
    <div th:fragment="submissionAttachment(attachmentId, filename, isImage, isPdf)">
        <div class="submission-attachment" th:if="${attachmentId != null}">
            <a th:href="@{/attachments/{id}/inline(id=${attachmentId})}"
               th:if="${isImage}"
               target="_blank" rel="noopener">
                <img class="submission-attachment-image"
                     th:src="@{/attachments/{id}/inline(id=${attachmentId})}"
                     th:alt="${filename}" />
            </a>
            <a class="submission-attachment-file"
               th:if="${isPdf}"
               th:href="@{/attachments/{id}/inline(id=${attachmentId})}"
               target="_blank" rel="noopener">
                PDF
            </a>
            <div class="submission-attachment-file" th:if="${!isImage and !isPdf}">
                File
            </div>
            <a class="submission-attachment-name"
               th:href="${isPdf ? '/attachments/' + attachmentId + '/inline' : '/attachments/' + attachmentId}"
               th:target="${isPdf ? '_blank' : null}"
               th:text="${filename}">
                file.ext
            </a>
        </div>
        <span th:if="${attachmentId == null}">—</span>
    </div>

    <!-- CREATE POST MODAL -->
    <div id="postCreateModal" class="modal-overlay" aria-hidden="true"
         th:if="${isTeacher and hasClass}"
         th:fragment="postCreateModal">
        <div class="modal" style="max-width:720px;">
            <div class="modal-header">
                <div class="modal-title">Create Post</div>
                <button class="modal-close" type="button" data-action="close-modal" data-modal-id="postCreateModal">×</button>
            </div>

            <div class="modal-body">
                <label class="field-label" for="pcType">Type</label>
                <select id="pcType" class="select">
                    <option value="ASSIGNMENT">Assignment</option>
                    <option value="RESOURCE">Resource (upload)</option>
                </select>
            </div>

            <!-- Assignment -->
            <form id="assignmentForm" class="modal-body" method="post" th:action="@{/classroom/post/assignment/add}" enctype="multipart/form-data">
                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="classroomId" th:value="${classroom.classId}" />

                <label class="field-label" for="pcAssignmentTitle">Title</label>
                <input id="pcAssignmentTitle" class="input" name="title" maxlength="80" placeholder="Title" required />

                <label class="field-label" for="pcAssignmentDesc">Description</label>
                <textarea id="pcAssignmentDesc" class="textarea" name="description" maxlength="4000" placeholder="Description"></textarea>

                <label class="field-label" for="pcAssignmentFile">Attachment (optional)</label>
                <input id="pcAssignmentFile" class="input js-file-input" type="file" name="file" multiple data-preview-target="pcAssignmentPreview" />
                <div id="pcAssignmentPreview" class="file-preview" aria-live="polite"></div>

                <div class="row">
                    <div class="col">
                        <label class="field-label" for="dueLocal">Due</label>
                        <input id="dueLocal" class="input" type="datetime-local" />
                        <input type="hidden" id="dueHidden" name="dueDate" />
                        <div class="help">Leave blank for no due date.</div>
                    </div>
                    <div class="col">
                        <label class="field-label" for="pcTimeToComplete">Time to complete</label>
                        <input id="pcTimeToComplete" class="input" name="timeToComplete" maxlength="32" placeholder="e.g. 2h" />
                    </div>
                </div>

                <label class="field-label" for="pcMaxMarks">Maximum marks</label>
                <input id="pcMaxMarks" class="input" name="maxMarks" type="number" min="0" placeholder="0" />

                <div class="modal-actions">
                    <button class="btn" type="button" data-action="close-modal" data-modal-id="postCreateModal">Cancel</button>
                    <button class="btn btn-primary" type="submit">Create</button>
                </div>
            </form>

            <!-- Resource (upload) -->
            <form id="resourceForm"
                  class="modal-body"
                  method="post"
                  th:action="@{/classroom/post/resource/add}"
                  enctype="multipart/form-data"
                  style="display:none;">

                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="classroomId" th:value="${classroom.classId}" />

                <label class="field-label" for="pcResourceTitle">Title</label>
                <input id="pcResourceTitle" class="input" name="title" maxlength="80" placeholder="Title" required />

                <label class="field-label" for="pcResourceFile">Upload file</label>
                <input id="pcResourceFile" class="input js-file-input" type="file" name="file" multiple data-preview-target="pcResourcePreview" required />
                <div id="pcResourcePreview" class="file-preview" aria-live="polite"></div>
                <div class="help">Resources are uploaded files (not links).</div>

                <label class="field-label" for="pcResourceDesc">Description</label>
                <textarea id="pcResourceDesc" class="textarea" name="description" maxlength="4000" placeholder="Description"></textarea>

                <div class="modal-actions">
                    <button class="btn" type="button" data-action="close-modal" data-modal-id="postCreateModal">Cancel</button>
                    <button class="btn btn-primary" type="submit">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- EDIT POST MODAL -->
    <div id="postEditModal" class="modal-overlay" aria-hidden="true"
         th:if="${isTeacher and hasClass}"
         th:fragment="postEditModal">
        <div class="modal" style="max-width:720px;">
            <div class="modal-header">
                <div class="modal-title">Edit Post</div>
                <button class="modal-close" type="button" data-action="close-modal" data-modal-id="postEditModal">×</button>
            </div>

            <form id="postEditForm" class="modal-body" method="post" action="/classroom/post/assignment/edit" enctype="multipart/form-data">
                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="classroomId" th:value="${classroom.classId}" />
                <input type="hidden" id="pePostId" name="postId" value="" />

                <label class="field-label" for="peTitle">Title</label>
                <input id="peTitle" class="input" name="title" maxlength="80" required />

                <label class="field-label" for="peDesc">Description</label>
                <textarea id="peDesc" class="textarea" name="description" maxlength="4000"></textarea>

                <div id="peExistingAttachmentsSection" style="display:none;">
                    <div class="field-label">Existing attachments</div>
                    <div id="peExistingAttachments" class="file-preview file-preview-existing" aria-live="polite"></div>
                    <div class="help">Click × to remove an attachment from this post.</div>
                </div>

                <!-- Assignment-only fields -->
                <div id="peAssignmentFields">
                    <div class="row">
                        <div class="col">
                            <label class="field-label" for="peDueLocal">Due</label>
                            <input id="peDueLocal" class="input" type="datetime-local" />
                            <input type="hidden" id="peDueHidden" name="dueDate" />
                            <div class="help">Leave blank for no due date.</div>
                        </div>
                        <div class="col">
                        <label class="field-label" for="peTtc">Time to complete</label>
                        <input id="peTtc" class="input" name="timeToComplete" maxlength="32" placeholder="e.g. 2h" />
                    </div>
                </div>

                    <label class="field-label" for="peMax">Maximum marks</label>
                    <input id="peMax" class="input" name="maxMarks" type="number" min="0" placeholder="0" />

                    <label class="field-label" for="peAssignmentFile">Add attachment (optional)</label>
                    <input id="peAssignmentFile" class="input js-file-input" type="file" name="file" multiple data-preview-target="peAssignmentPreview" />
                    <div id="peAssignmentPreview" class="file-preview" aria-live="polite"></div>
                </div>

                <!-- Resource-only fields -->
                <div id="peResourceFields" style="display:none;">
                    <label class="field-label" for="peResourceFile">Replace uploaded file (optional)</label>
                    <input id="peResourceFile" class="input js-file-input" type="file" name="file" multiple data-preview-target="peResourcePreview" />
                    <div id="peResourcePreview" class="file-preview" aria-live="polite"></div>
                    <label class="field-label" for="peReplaceAtts" style="display:flex;align-items:center;gap:10px;margin-top:10px;">
                        <input id="peReplaceAtts" type="checkbox" name="replaceAttachments" value="true" />
                        Replace existing attachment(s)
                    </label>
                    <div class="help">If checked, existing attachment(s) will be replaced with the uploaded file.</div>
                </div>

                <div class="modal-actions">
                    <button class="btn" type="button" data-action="close-modal" data-modal-id="postEditModal">Cancel</button>
                    <button class="btn btn-primary" type="submit">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- STUDENT SUBMIT MODAL -->
    <div id="submitModal" class="modal-overlay" aria-hidden="true"
         th:if="${isStudent and hasClass}"
         th:fragment="submitModal">
        <div class="modal" style="max-width:720px;">
            <div class="modal-header">
                <div class="modal-title">Submit Assignment</div>
                <button class="modal-close" type="button" data-action="close-modal" data-modal-id="submitModal">×</button>
            </div>

            <form class="modal-body"
                  method="post"
                  th:action="@{/classroom/post/assignment/submit}"
                  enctype="multipart/form-data">

                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="classroomId" th:value="${classroom.classId}" />
                <input type="hidden" id="smAssignmentId" name="assignmentId" value="" />
                <input type="hidden" id="smRemoveAttachment" name="removeAttachment" value="false" />

                <div class="submission-post-card">
                    <div class="submission-post-title" id="smPostTitle">Assignment</div>
                    <div class="submission-post-meta" id="smPostMeta"></div>
                    <div class="submission-post-desc" id="smPostDesc"></div>
                </div>

                <label class="field-label" for="smFile">Upload work</label>
                <input id="smFile" class="input js-file-input" type="file" name="file" data-preview-target="smPreview" />
                <div id="smPreview" class="file-preview" aria-live="polite"></div>
                <div class="help">Optional: submit without a file if you only want to mark complete.</div>

                <div id="smExistingAttachmentSection" style="display:none;">
                    <div class="field-label">Existing attachment</div>
                    <div id="smExistingAttachment" class="file-preview file-preview-existing" aria-live="polite"></div>
                    <div class="help">Click × to remove the existing attachment.</div>
                </div>

                <label class="field-label" for="smMarkComplete" style="display:flex;align-items:center;gap:10px;">
                    <input id="smMarkComplete" type="checkbox" name="markComplete" value="true" />
                    Mark as complete
                </label>

                <div class="modal-actions">
                    <button class="btn" type="button" data-action="close-modal" data-modal-id="submitModal">Cancel</button>
                    <button class="btn btn-primary" type="submit">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SUBMISSION REVIEW MODAL -->
    <div id="submissionReviewModal" class="modal-overlay" aria-hidden="true"
         th:if="${isTeacher and hasClass}"
         th:fragment="submissionReviewModal">
        <div class="modal" style="max-width:980px;">
            <div class="modal-header">
                <div class="modal-title">Assignment Submissions</div>
                <button class="modal-close" type="button" data-action="close-modal" data-modal-id="submissionReviewModal">×</button>
            </div>

            <div class="modal-body">
                <label class="field-label" for="submissionFilter">Assignment</label>
                <select id="submissionFilter" class="select">
                    <option th:each="post : ${posts}"
                            th:if="${post.postType.name() == 'ASSIGNMENT'}"
                            th:value="${post.postId}"
                            th:text="${post.title}"
                            th:attr="data-due=${post.dueDate}">
                        Assignment
                    </option>
                </select>

                <div class="submission-nav">
                    <button class="icon-btn submission-nav-btn" type="button" id="submissionPrev" aria-label="Previous student">◀</button>
                    <div class="submission-nav-status" id="submissionNavStatus">0 / 0</div>
                    <button class="icon-btn submission-nav-btn" type="button" id="submissionNext" aria-label="Next student">▶</button>
                </div>

                <div class="submission-cards"
                     th:if="${submissionReviews != null and !#lists.isEmpty(submissionReviews)}">
                    <div class="submission-card"
                         th:each="review : ${submissionReviews}"
                         data-submission-card="true"
                         th:attr="data-assignment-id=${review.assignmentId},
                                  data-submitted-at=${review.submissionTime != null ? #temporals.format(review.submissionTime, 'yyyy-MM-dd''T''HH:mm:ss''Z''') : ''}"
                         th:classappend="${(review.marksScored != null) or (review.feedback != null and !#strings.isEmpty(review.feedback))} ? ' is-marked' : ''"
                         th:with="filename=${T(com.binder.demo.services.AttachmentService).filenameFromUrl(review.attachmentUrl)},
                                  lower=${#strings.toLowerCase(filename)},
                                  isImage=${lower.endsWith('.png') or lower.endsWith('.jpg') or lower.endsWith('.jpeg') or lower.endsWith('.gif') or lower.endsWith('.webp')},
                                  isPdf=${lower.endsWith('.pdf')}">
                        <div class="submission-card-header">
                            <div>
                                <div class="submission-student" th:text="${review.studentName}">Student Name</div>
                                <div class="submission-email" th:text="${review.studentEmail}">student@email.com</div>
                            </div>
                            <div class="submission-status">
                                <span class="submission-overdue">Overdue</span>
                                <span class="submission-marked" aria-live="polite">Marked</span>
                            </div>
                        </div>

                        <div class="submission-card-body">
                            <div class="submission-card-main">
                                <div class="submission-meta">
                                    <div class="submission-meta-label">Assignment</div>
                                    <div class="submission-meta-value" th:text="${review.assignmentTitle}">Assignment</div>
                                </div>

                                <div class="submission-meta">
                                    <div class="submission-meta-label">Submitted</div>
                                    <div class="submission-meta-value"
                                         th:text="${review.submissionTime != null ? #temporals.format(review.submissionTime, 'yyyy-MM-dd HH:mm') : '—'}">
                                        time
                                    </div>
                                </div>

                                <div class="submission-meta">
                                    <div class="submission-meta-label">Attachment</div>
                                    <div class="submission-meta-value">
                                        <div th:replace="~{fragments/classroom-modals :: submissionAttachment(attachmentId=${review.attachmentId}, filename=${filename}, isImage=${isImage}, isPdf=${isPdf})}"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="submission-card-side">
                                <form method="post" th:action="@{/classroom/post/assignment/grade}" class="submission-grade-form">
                                    <input type="hidden" th:if="${_csrf != null}"
                                           th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <input type="hidden" name="classroomId" th:value="${classroom.classId}" />
                                    <input type="hidden" name="submissionId" th:value="${review.submissionId}" />
                                    <div class="submission-grade-header">
                                        <div class="submission-grade-marks">
                                            <label class="field-label" th:for="'gradeMarks-' + ${review.submissionId}">
                                                Marks<span th:if="${review.maxMarks != null}" th:text="' / ' + ${review.maxMarks}"></span>
                                            </label>
                                            <input class="input submission-grade-input"
                                                   th:id="'gradeMarks-' + ${review.submissionId}"
                                                   name="marksScored" type="number" min="0"
                                                   th:attr="max=${review.maxMarks}"
                                                   th:value="${review.marksScored}" placeholder="Marks" />
                                        </div>
                                        <button class="btn btn-primary submission-grade-btn" type="submit">Save</button>
                                    </div>
                                    <div class="submission-grade-fields">
                                        <label class="field-label" th:for="'gradeFeedback-' + ${review.submissionId}">Feedback</label>
                                        <textarea class="textarea submission-grade-textarea"
                                                  th:id="'gradeFeedback-' + ${review.submissionId}"
                                                  name="feedback" rows="8"
                                                  th:text="${review.feedback}" placeholder="Feedback"></textarea>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="submissionReviewEmpty" class="help"
                     th:style="${submissionReviews == null or #lists.isEmpty(submissionReviews)} ? '' : 'display:none;'">
                    No submissions yet.
                </div>

            </div>
        </div>
    </div>

    <!-- STUDENT RESULT MODAL -->
    <div id="studentResultModal" class="modal-overlay" aria-hidden="true"
         th:if="${isStudent and hasClass}"
         th:fragment="studentResultModal">
        <div class="modal" style="max-width:900px;">
            <div class="modal-header">
                <div class="modal-title">Submission Results</div>
                <button class="modal-close" type="button" data-action="close-modal" data-modal-id="studentResultModal">×</button>
            </div>

            <div class="modal-body">
                <label class="field-label" for="studentResultFilter">Assignment</label>
                <select id="studentResultFilter" class="select">
                    <option th:each="post : ${posts}"
                            th:if="${post.postType.name() == 'ASSIGNMENT'}"
                            th:value="${post.postId}"
                            th:text="${post.title}">
                        Assignment
                    </option>
                </select>

                <div class="submission-nav">
                    <button class="icon-btn submission-nav-btn" type="button" id="studentResultPrev" aria-label="Previous result">◀</button>
                    <div class="submission-nav-status" id="studentResultStatus">0 / 0</div>
                    <button class="icon-btn submission-nav-btn" type="button" id="studentResultNext" aria-label="Next result">▶</button>
                </div>

                <div class="submission-cards"
                     th:if="${studentSubmissionResults != null and !#lists.isEmpty(studentSubmissionResults)}">
                    <div class="submission-card"
                         th:each="result : ${studentSubmissionResults}"
                         data-student-result-card="true"
                         th:attr="data-assignment-id=${result.assignmentId}"
                         th:classappend="${(result.marksScored != null) or (result.feedback != null and !#strings.isEmpty(result.feedback))} ? ' is-marked' : ''"
                         th:with="filename=${T(com.binder.demo.services.AttachmentService).filenameFromUrl(result.attachmentUrl)},
                                  lower=${#strings.toLowerCase(filename)},
                                  isImage=${lower.endsWith('.png') or lower.endsWith('.jpg') or lower.endsWith('.jpeg') or lower.endsWith('.gif') or lower.endsWith('.webp')},
                                  isPdf=${lower.endsWith('.pdf')}">
                        <div class="submission-card-header">
                            <div>
                                <div class="submission-student" th:text="${result.assignmentTitle}">Assignment</div>
                                <div class="submission-email">Your submission</div>
                            </div>
                            <div class="submission-marked" aria-live="polite">Marked</div>
                        </div>

                        <div class="submission-meta">
                            <div class="submission-meta-label">Submitted</div>
                            <div class="submission-meta-value"
                                 th:text="${result.submissionTime != null ? #temporals.format(result.submissionTime, 'yyyy-MM-dd HH:mm') : '—'}">
                                time
                            </div>
                        </div>

                        <div class="submission-meta">
                            <div class="submission-meta-label">Attachment</div>
                            <div class="submission-meta-value">
                                <div th:replace="~{fragments/classroom-modals :: submissionAttachment(attachmentId=${result.attachmentId}, filename=${filename}, isImage=${isImage}, isPdf=${isPdf})}"></div>
                            </div>
                        </div>

                        <div class="submission-meta">
                            <div class="submission-meta-label">Grade</div>
                            <div class="submission-meta-value"
                                 th:text="${(result.marksScored != null and result.maxMarks != null) ? result.marksScored + ' / ' + result.maxMarks : (result.marksScored != null ? result.marksScored : 'Not graded')}">
                                Not graded
                            </div>
                        </div>

                        <div class="submission-meta">
                            <div class="submission-meta-label">Feedback</div>
                            <div class="submission-meta-value">
                                <textarea class="textarea submission-grade-textarea" rows="4" readonly
                                          th:text="${result.feedback}"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="studentResultEmpty" class="help"
                     th:style="${studentSubmissionResults == null or #lists.isEmpty(studentSubmissionResults)} ? '' : 'display:none;'">
                    No submissions yet.
                </div>

                <div class="modal-actions">
                    <button class="btn" type="button" data-action="close-modal" data-modal-id="studentResultModal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT CLASSROOM MODAL -->
    <div id="classroomEditModal" class="modal-overlay" aria-hidden="true"
         th:if="${isTeacher and hasClass}"
         th:fragment="classroomEditModal">
        <div class="modal" style="max-width:860px;">
            <div class="modal-header">
                <div class="modal-title">Edit Classroom</div>
                <button class="modal-close" type="button" data-action="close-modal" data-modal-id="classroomEditModal">×</button>
            </div>

            <div class="modal-body" style="padding-top:0;">
                <form method="post" action="/classrooms/update">
                    <input type="hidden" th:if="${_csrf != null}"
                           th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" name="classId" th:value="${classroom.classId}" />

                    <label class="field-label" for="ceName">Name</label>
                    <input id="ceName" class="input" name="name" maxlength="60" th:value="${classroom.name}" required />

                    <label class="field-label" for="ceDesc">Description</label>
                    <textarea id="ceDesc" class="textarea" name="description" maxlength="500" th:text="${classroom.description}"></textarea>

                    <div class="modal-actions" style="justify-content:flex-end;">
                        <button class="btn btn-primary" type="submit">Save</button>
                    </div>
                </form>

                <div style="margin-top:14px;">
                    <form method="post" action="/classrooms/delete"
                          onsubmit="return confirm('Delete this classroom? This cannot be undone.');">
                        <input type="hidden" th:if="${_csrf != null}"
                               th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="classId" th:value="${classroom.classId}" />
                        <button class="btn btn-danger" type="submit">Delete classroom</button>
                    </form>
                </div>

                <div class="modal-actions">
                    <button class="btn" type="button" data-action="close-modal" data-modal-id="classroomEditModal">Close</button>
                </div>
            </div>
        </div>
    </div>
</th:block>
