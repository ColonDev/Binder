<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title th:text="${classroom != null} ? (${classroom.name} + ' - Binder') : 'Classroom - Binder'">
        Classroom - Binder
    </title>

    <link rel="stylesheet" th:href="@{/css/base.css}" />
    <link rel="stylesheet" th:href="@{/css/dashboard.css}" />
    <link rel="stylesheet" th:href="@{/css/classroom.css(v=${#dates.createNow().time})}" href="/css/classroom.css" />
</head>

<body>
<div class="app">
    <div th:replace="~{fragments/sidebar :: sidebar('classroom')}"></div>

    <main id="main"
          class="main"
          th:with="isTeacher=${#strings.toString(role) == 'TEACHER'}, isStudent=${#strings.toString(role) == 'STUDENT'}, hasClass=${classroom != null}"
          th:classappend="${isTeacher and hasClass} ? ' has-ribbon' : ''">

        <div class="ribbon"
             th:if="${isTeacher and hasClass}"
             data-action="toggle-manage">Manage</div>

        <aside id="manageSide" class="manage-side" aria-hidden="true"
               th:if="${isTeacher and hasClass}">
            <div class="manage-inner">
                <div class="manage-card">
                    <div class="header">Classroom</div>
                    <div class="body">
                        <button class="btn btn-primary" type="button" data-action="open-modal" data-modal-id="postCreateModal">Create Post</button>
                        <button class="btn" type="button" data-action="open-modal" data-modal-id="submissionReviewModal" style="margin-top:10px;">Review Submissions</button>
                        <button class="btn" type="button" data-action="open-modal" data-modal-id="classroomEditModal" style="margin-top:10px;">Edit Classroom</button>
                    </div>
                </div>

                <div class="manage-card">
                    <div class="header">Enrolled students</div>
                    <div class="body">
                        <label class="field-label" for="enrollmentFilter">View</label>
                        <select id="enrollmentFilter" class="select" data-action="switch-enrollment-list">
                            <option value="students">Students</option>
                            <option value="teachers">Teachers</option>
                        </select>

                        <div class="cm-section" data-list="students">
                            <div class="form-error" th:if="${studentEnrollError}" th:text="${studentEnrollError}"></div>
                            <div class="cm-list">
                                <div class="cm-chip" th:each="student : ${enrolledStudents}">
                                    <div class="cm-chip-text" th:text="${student}">student@email.com</div>
                                    <form method="post" action="/classrooms/remove-student" style="margin:0;">
                                        <input type="hidden" th:if="${_csrf != null}"
                                               th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <input type="hidden" name="classId" th:value="${classroom.classId}" />
                                        <input type="hidden" name="email" th:value="${student}" />
                                        <button class="icon-btn" type="submit" title="Remove">×</button>
                                    </form>
                                </div>

                                <div class="help" th:if="${enrolledStudents == null || #lists.isEmpty(enrolledStudents)}">
                                    No students listed.
                                </div>
                            </div>

                            <form class="cm-addrow" method="post" action="/classrooms/enroll">
                                <input type="hidden" th:if="${_csrf != null}"
                                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <input type="hidden" name="classId" th:value="${classroom.classId}" />
                                <label class="field-label" for="cmStudentEmails"
                                       style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">
                                    Student emails
                                </label>
                                <input id="cmStudentEmails" class="input" name="studentEmails" type="email" placeholder="Input email"
                                       maxlength="254" required />
                                <button class="btn btn-primary" type="submit">Add</button>
                            </form>
                        </div>

                        <div class="cm-section" data-list="teachers" style="display:none;">
                            <div class="form-error" th:if="${teacherEnrollError}" th:text="${teacherEnrollError}"></div>
                            <div class="cm-list">
                                <div class="cm-chip" th:each="teacher : ${enrolledTeachers}">
                                    <div class="cm-chip-text" th:text="${teacher}">teacher@email.com</div>
                                </div>

                                <div class="help" th:if="${enrolledTeachers == null || #lists.isEmpty(enrolledTeachers)}">
                                    No teachers listed.
                                </div>
                            </div>

                            <form class="cm-addrow" method="post" action="/classrooms/enroll-teachers">
                                <input type="hidden" th:if="${_csrf != null}"
                                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <input type="hidden" name="classId" th:value="${classroom.classId}" />
                                <label class="field-label" for="cmTeacherEmails"
                                       style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">
                                    Teacher emails
                                </label>
                                <input id="cmTeacherEmails" class="input" name="teacherEmails" type="email" placeholder="Input email"
                                       maxlength="254" required />
                                <button class="btn btn-primary" type="submit">Add</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <div class="paper">
            <h1 class="page-title"
                th:text="${classroom != null} ? ${classroom.name} : 'Classroom'">
                Classroom
            </h1>

            <!-- Sort / Filter -->
            <div class="stream-toolbar" th:if="${posts != null && !#lists.isEmpty(posts)}">
                <div class="left">
                    <label for="postFilter">Show</label>
                    <select id="postFilter" class="select">
                        <option value="ALL">All</option>
                        <option value="ASSIGNMENT">Assignments</option>
                        <option value="RESOURCE">Resources</option>
                    </select>
                </div>

                <div class="right" th:if="${isStudent}">
                    <span class="help">Status shown per assignment.</span>
                </div>
            </div>

            <section class="stream">
                <div th:if="${posts == null or #lists.isEmpty(posts)}" class="empty-msg">
                    There are no posts in this classroom yet.
                </div>

                <article th:each="post : ${posts}"
                         class="post-note"
                         th:attr="data-type=${post.postType}, data-post-id=${post.postId}"
                         th:classappend="${post.postType == T(com.binder.demo.classroom.PostType).RESOURCE} ? ' is-resource' : ''">

                    <div class="post-note-header">
                        <div>
                            <h2 class="post-note-title" th:text="${post.title}">Title</h2>
                            <div class="post-note-meta">
                                <span th:text="${post.postType}">ASSIGNMENT</span>
                                <span th:if="${post.postType.name() == 'ASSIGNMENT' and post.dueDate != null}">
                                    • <span th:text="'Due ' + ${#temporals.format(post.dueDate, 'yyyy-MM-dd HH:mm')}"></span>
                                </span>
                            </div>
                        </div>

                        <div th:replace="~{fragments/post-controls :: postHeaderControls(post=${post}, classroom=${classroom}, isTeacher=${isTeacher})}"></div>
                    </div>

                    <div class="post-note-body" th:text="${post.description}">Description</div>

                    <div class="post-attachments"
                         th:if="${post.attachments != null and !post.attachments.isEmpty()}">
                        <div class="post-attachments-title">Attachments</div>
                        <div class="post-attachments-grid">
                            <div class="post-attachment"
                                 th:each="att : ${post.attachments}"
                                 th:with="filename=${T(com.binder.demo.services.AttachmentService).filenameFromUrl(att.url)},
                                          lower=${#strings.toLowerCase(filename)},
                                          isImage=${lower.endsWith('.png') or lower.endsWith('.jpg') or lower.endsWith('.jpeg') or lower.endsWith('.gif') or lower.endsWith('.webp')},
                                          isPdf=${lower.endsWith('.pdf')},
                                          inlineUrl=${(isImage or isPdf) ? '/attachments/' + att.attachmentId + '/inline' : ''},
                                          downloadUrl=${'/attachments/' + att.attachmentId}"
                                 th:attr="data-attachment-id=${att.attachmentId},
                                          data-attachment-name=${filename},
                                          data-attachment-image=${isImage},
                                          data-attachment-inline=${inlineUrl},
                                          data-attachment-download=${downloadUrl}">
                                <a class="post-attachment-preview"
                                   th:href="${isImage or isPdf ? inlineUrl : downloadUrl}"
                                   th:target="${isImage or isPdf ? '_blank' : null}">
                                    <img class="post-attachment-image"
                                         th:if="${isImage}"
                                         th:src="@{/attachments/{id}/inline(id=${att.attachmentId})}"
                                         th:alt="${filename}" />
                                    <div class="post-attachment-file"
                                         th:if="${!isImage}">
                                        File
                                    </div>
                                </a>
                                <div class="post-attachment-meta">
                                    <div class="post-attachment-name" th:text="${filename}">file.ext</div>
                                    <a class="post-attachment-link"
                                       th:href="@{/attachments/{id}(id=${att.attachmentId})}">
                                        Download
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div th:replace="~{fragments/post-controls :: postActions(post=${post}, classroom=${classroom}, submittedPostIds=${submittedPostIds}, isTeacher=${isTeacher}, isStudent=${isStudent})}"></div>
                </article>
            </section>
        </div>
        <div th:replace="~{fragments/classroom-modals :: postCreateModal}"></div>
        <div th:replace="~{fragments/classroom-modals :: postEditModal}"></div>
        <div th:replace="~{fragments/classroom-modals :: submitModal}"></div>
        <div th:replace="~{fragments/classroom-modals :: submissionReviewModal}"></div>
        <div th:replace="~{fragments/classroom-modals :: studentResultModal}"></div>
        <div th:replace="~{fragments/classroom-modals :: classroomEditModal}"></div>
        <div id="studentSubmissionData"
             th:if="${studentSubmissionResults != null}"
             style="display:none;">
            <div th:each="result : ${studentSubmissionResults}"
                 th:with="filename=${T(com.binder.demo.services.AttachmentService).filenameFromUrl(result.attachmentUrl)},
                          lower=${#strings.toLowerCase(filename)},
                          isImage=${lower.endsWith('.png') or lower.endsWith('.jpg') or lower.endsWith('.jpeg') or lower.endsWith('.gif') or lower.endsWith('.webp')},
                          isPdf=${lower.endsWith('.pdf')}"
                 th:attr="data-assignment-id=${result.assignmentId},
                          data-attachment-id=${result.attachmentId},
                          data-attachment-name=${filename},
                          data-attachment-url=${result.attachmentUrl},
                          data-attachment-image=${isImage},
                          data-attachment-pdf=${isPdf}">
            </div>
        </div>
    </main>
</div>

<script th:src="@{/js/classroom.js(v=${#dates.createNow().time})}" src="/js/classroom.js"></script>
</body>
</html>
